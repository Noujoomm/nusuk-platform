generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── USERS & AUTH ───

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String
  nameAr         String   @map("name_ar")
  passwordHash   String   @map("password_hash")
  role           Role     @default(employee)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  refreshTokens    RefreshToken[]
  trackPermissions TrackPermission[]
  records          Record[]         @relation("CreatedBy")
  auditLogs        AuditLog[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

enum Role {
  admin
  pm
  track_lead
  employee
  hr
}

// ─── TRACKS ───

model Track {
  id            String   @id @default(cuid())
  name          String   @unique
  nameAr        String   @map("name_ar")
  description   String?
  descriptionAr String?  @map("description_ar")
  color         String   @default("#10B981")
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  fieldSchema   Json?    @map("field_schema") // JSON schema for extra fields
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  permissions TrackPermission[]
  records     Record[]
  auditLogs   AuditLog[]

  @@map("tracks")
}

model TrackPermission {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  trackId     String   @map("track_id")
  permissions String[] // ['view','edit','create','delete','export']
  createdAt   DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([userId, trackId])
  @@index([userId])
  @@index([trackId])
  @@map("track_permissions")
}

// ─── RECORDS (hybrid typed + JSONB) ───

model Record {
  id          String       @id @default(cuid())
  trackId     String       @map("track_id")
  title       String
  titleAr     String?      @map("title_ar")
  status      RecordStatus @default(draft)
  priority    Priority     @default(medium)
  owner       String?
  dueDate     DateTime?    @map("due_date")
  progress    Float        @default(0)
  notes       String?
  extraFields Json?        @map("extra_fields") // JSONB for custom track fields
  version     Int          @default(1)
  createdById String       @map("created_by_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  track     Track @relation(fields: [trackId], references: [id], onDelete: Cascade)
  createdBy User  @relation("CreatedBy", fields: [createdById], references: [id])

  @@index([trackId])
  @@index([status])
  @@index([createdById])
  @@map("records")
}

enum RecordStatus {
  draft
  active
  in_progress
  completed
  cancelled
}

enum Priority {
  low
  medium
  high
  critical
}

// ─── AUDIT LOG ───

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?  @map("actor_id")
  actionType String   @map("action_type") // create, update, delete, login, logout
  entityType String   @map("entity_type") // record, track, user, etc.
  entityId   String?  @map("entity_id")
  trackId    String?  @map("track_id")
  beforeData Json?    @map("before_data")
  afterData  Json?    @map("after_data")
  ip         String?
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  actor User?  @relation(fields: [actorId], references: [id], onDelete: SetNull)
  track Track? @relation(fields: [trackId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([trackId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
