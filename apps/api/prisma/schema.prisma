generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── USERS & AUTH ───

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String
  nameAr         String   @map("name_ar")
  passwordHash   String   @map("password_hash")
  role           Role     @default(employee)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  refreshTokens    RefreshToken[]
  trackPermissions TrackPermission[]
  records          Record[]         @relation("CreatedBy")
  auditLogs        AuditLog[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

enum Role {
  admin
  pm
  track_lead
  employee
  hr
}

// ─── TRACKS ───

model Track {
  id            String   @id @default(cuid())
  name          String   @unique
  nameAr        String   @map("name_ar")
  description   String?
  descriptionAr String?  @map("description_ar")
  color         String   @default("#10B981")
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  fieldSchema   Json?    @map("field_schema") // JSON schema for extra fields
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  permissions  TrackPermission[]
  records      Record[]
  auditLogs    AuditLog[]
  employees    Employee[]
  deliverables Deliverable[]
  kpis         TrackKPI[]
  penalties    Penalty[]
  scopes       Scope[]

  @@map("tracks")
}

model TrackPermission {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  trackId     String   @map("track_id")
  permissions String[] // ['view','edit','create','delete','export']
  createdAt   DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([userId, trackId])
  @@index([userId])
  @@index([trackId])
  @@map("track_permissions")
}

// ─── EMPLOYEES (from Excel) ───

model Employee {
  id              String   @id @default(cuid())
  trackId         String?  @map("track_id")
  fullName        String   @map("full_name")
  fullNameAr      String   @map("full_name_ar")
  position        String?
  positionAr      String?  @map("position_ar")
  subTrack        String?  @map("sub_track")
  directManager   String?  @map("direct_manager")
  contractStatus  String?  @map("contract_status")
  jobDescription  String?  @map("job_description")  @db.Text
  kpiText         String?  @map("kpi_text")          @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  track     Track?     @relation(fields: [trackId], references: [id], onDelete: SetNull)
  contracts Contract[]

  @@index([trackId])
  @@map("employees")
}

model Contract {
  id            String   @id @default(cuid())
  employeeId    String?  @map("employee_id")
  employeeName  String   @map("employee_name")
  position      String?
  trackName     String?  @map("track_name")
  contractType  String?  @map("contract_type")
  monthlySalary Float?   @map("monthly_salary")
  months        Float?
  totalValue    Float?   @map("total_value")
  createdAt     DateTime @default(now()) @map("created_at")

  employee Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@map("contracts")
}

model Deliverable {
  id                  String   @id @default(cuid())
  trackId             String   @map("track_id")
  name                String
  nameAr              String   @map("name_ar")
  outputs             String?  @db.Text
  deliveryIndicators  String?  @map("delivery_indicators") @db.Text
  sortOrder           Int      @default(0)  @map("sort_order")
  createdAt           DateTime @default(now()) @map("created_at")

  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@map("deliverables")
}

model TrackKPI {
  id        String   @id @default(cuid())
  trackId   String   @map("track_id")
  name      String   @db.Text
  nameAr    String   @map("name_ar") @db.Text
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@map("track_kpis")
}

model Penalty {
  id          String   @id @default(cuid())
  trackId     String   @map("track_id")
  violation   String   @db.Text
  violationAr String  @map("violation_ar") @db.Text
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@map("penalties")
}

model Scope {
  id          String   @id @default(cuid())
  trackId     String   @map("track_id")
  title       String   @db.Text
  titleAr     String   @map("title_ar") @db.Text
  description String?  @db.Text
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
  @@map("scopes")
}

model FinancialCost {
  id          String   @id @default(cuid())
  trackName   String   @map("track_name")
  itemDetail  String   @map("item_detail")
  tasks       String?  @db.Text
  type        String?
  months      Float?
  quantity    Float?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("financial_costs")
}

// ─── RECORDS (hybrid typed + JSONB) ───

model Record {
  id          String       @id @default(cuid())
  trackId     String       @map("track_id")
  title       String
  titleAr     String?      @map("title_ar")
  status      RecordStatus @default(draft)
  priority    Priority     @default(medium)
  owner       String?
  dueDate     DateTime?    @map("due_date")
  progress    Float        @default(0)
  notes       String?
  extraFields Json?        @map("extra_fields") // JSONB for custom track fields
  version     Int          @default(1)
  createdById String       @map("created_by_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  track     Track @relation(fields: [trackId], references: [id], onDelete: Cascade)
  createdBy User  @relation("CreatedBy", fields: [createdById], references: [id])

  @@index([trackId])
  @@index([status])
  @@index([createdById])
  @@map("records")
}

enum RecordStatus {
  draft
  active
  in_progress
  completed
  cancelled
}

enum Priority {
  low
  medium
  high
  critical
}

// ─── AUDIT LOG ───

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?  @map("actor_id")
  actionType String   @map("action_type") // create, update, delete, login, logout
  entityType String   @map("entity_type") // record, track, user, etc.
  entityId   String?  @map("entity_id")
  trackId    String?  @map("track_id")
  beforeData Json?    @map("before_data")
  afterData  Json?    @map("after_data")
  ip         String?
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  actor User?  @relation(fields: [actorId], references: [id], onDelete: SetNull)
  track Track? @relation(fields: [trackId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([trackId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
